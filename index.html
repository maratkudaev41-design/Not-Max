    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // User Data Management
        let currentUser = null;
        let currentChat = null;
        let chats = JSON.parse(localStorage.getItem('notmax_chats')) || [];
        let users = JSON.parse(localStorage.getItem('notmax_users')) || {};
        let socket = null;

        // WebRTC Variables
        let localStream;
        let remoteStream;
        let peerConnection;
        let isCaller = false;
        let currentCallType = 'audio';

        // Auth Functions
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        function register() {
            const name = document.getElementById('regName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;

            if (!name || !username || !password) {
                alert('Заполните все поля');
                return;
            }

            if (users[username]) {
                alert('Пользователь с таким именем уже существует');
                return;
            }

            // Create new user
            users[username] = {
                name: name,
                username: username,
                password: password,
                avatar: name.charAt(0).toUpperCase()
            };

            localStorage.setItem('notmax_users', JSON.stringify(users));
            
            // Auto login
            loginUser(username, password);
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            loginUser(username, password);
        }

        function loginUser(username, password) {
            const user = users[username];
            
            if (!user || user.password !== password) {
                alert('Неверное имя пользователя или пароль');
                return;
            }

            currentUser = user;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('messengerApp').style.display = 'flex';
            
            updateUserProfile();
            loadChats();
            initSocket();
        }

        function logout() {
            if (socket) {
                socket.disconnect();
            }
            currentUser = null;
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('messengerApp').style.display = 'none';
            showLogin();
        }

        function updateUserProfile() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileUsername').textContent = '@' + currentUser.username;
            document.getElementById('profileAvatar').textContent = currentUser.avatar;
        }

        // Socket.io initialization
        function initSocket() {
            try {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('Connected to server');
                    // Регистрируем пользователя на сервере
                    socket.emit('register', {
                        username: currentUser.username,
                        name: currentUser.name
                    });
                });

                socket.on('new-message', (message) => {
                    console.log('New message received:', message);
                    
                    // Находим чат с этим пользователем
                    const chat = chats.find(c => c.friendUsername === message.from);
                    if (chat) {
                        // Добавляем сообщение в историю
                        const newMessage = {
                            text: message.text,
                            isSent: false,
                            timestamp: message.timestamp
                        };
                        
                        chat.messages.push(newMessage);
                        localStorage.setItem('notmax_chats', JSON.stringify(chats));
                        
                        // Если этот чат активен - показываем сообщение
                        if (currentChat && currentChat.id === chat.id) {
                            addMessageToUI(message.text, false, message.timestamp, true);
                        }
                        
                        // Обновляем список чатов
                        loadChats();
                    }
                });

                socket.on('message-history', (history) => {
                    console.log('Message history:', history);
                    // Пока не используем историю с сервера, используем локальную
                });

                // WebRTC events
                socket.on('call-made', async (data) => {
                    console.log('Incoming call from:', data.from);
                    document.getElementById('callerName').textContent = `Входящий звонок от ${data.callerName}`;
                    document.getElementById('callStatus').textContent = 'Входящий вызов...';
                    document.getElementById('callInterface').style.display = 'block';
                    document.getElementById('acceptBtn').style.display = 'block';
                    
                    currentCallType = data.type;
                    isCaller = false;
                    
                    await createPeerConnection(false);
                    await peerConnection.setRemoteDescription(new RTCSessionDescription({
                        type: 'offer',
                        sdp: data.offer
                    }));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    socket.emit('make-answer', {
                        answer: answer,
                        to: data.from
                    });
                });
                
                socket.on('answer-made', async (data) => {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription({
                        type: 'answer',
                        sdp: data.answer
                    }));
                    document.getElementById('callStatus').textContent = 'Разговор...';
                });
                
                socket.on('ice-candidate', async (data) => {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                });

            } catch (error) {
                console.log('Socket.io error:', error);
            }
        }

        // Chat Management
        function loadChats() {
            const chatsList = document.getElementById('chatsList');
            chatsList.innerHTML = '';

            if (chats.length === 0) {
                chatsList.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">Нет чатов</div>';
                return;
            }

            chats.forEach(chat => {
                const lastMessage = chat.messages[chat.messages.length - 1];
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.onclick = () => selectChat(chat.id);
                
                chatItem.innerHTML = `
                    <div class="chat-avatar">${chat.friendAvatar}</div>
                    <div class="chat-content">
                        <div class="chat-header">
                            <div class="chat-name">${chat.friendName}</div>
                            <div class="chat-time">${lastMessage ? formatTime(lastMessage.timestamp) : ''}</div>
                        </div>
                        <div class="last-message">${lastMessage ? lastMessage.text : 'Нет сообщений'}</div>
                    </div>
                `;
                
                chatsList.appendChild(chatItem);
            });
        }

        function showNewChatModal() {
            document.getElementById('newChatModal').classList.add('active');
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.remove('active');
        }

        function createNewChat() {
            const friendUsername = document.getElementById('friendUsername').value.trim();
            const friendDisplayName = document.getElementById('friendDisplayName').value.trim();

            if (!friendUsername || !friendDisplayName) {
                alert('Заполните все поля');
                return;
            }

            // Check if chat already exists
            const existingChat = chats.find(chat => chat.friendUsername === friendUsername);
            if (existingChat) {
                alert('Чат с этим пользователем уже существует');
                return;
            }

            const newChat = {
                id: Date.now().toString(),
                friendName: friendDisplayName,
                friendUsername: friendUsername,
                friendAvatar: friendDisplayName.charAt(0).toUpperCase(),
                messages: [],
                createdAt: Date.now()
            };

            chats.push(newChat);
            localStorage.setItem('notmax_chats', JSON.stringify(chats));
            
            closeNewChatModal();
            loadChats();
            selectChat(newChat.id);
        }

        function selectChat(chatId) {
            currentChat = chats.find(chat => chat.id === chatId);
            if (!currentChat) return;

            // Update UI
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('inputContainer').style.display = 'flex';
            document.getElementById('currentChatName').textContent = currentChat.friendName;
            document.getElementById('currentChatAvatar').textContent = currentChat.friendAvatar;
            document.getElementById('currentChatStatus').textContent = 'online';

            // Load messages
            loadMessages();
        }

        function loadMessages() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';

            if (!currentChat || currentChat.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        <i class="fas fa-comment" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>Начните общение с ${currentChat.friendName}</p>
                    </div>
                `;
                return;
            }

            currentChat.messages.forEach(message => {
                addMessageToUI(message.text, message.isSent, message.timestamp, false);
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text || !currentChat) return;

            const message = {
                text: text,
                isSent: true,
                timestamp: Date.now()
            };

            // Add to current chat
            currentChat.messages.push(message);
            
            // Update storage
            localStorage.setItem('notmax_chats', JSON.stringify(chats));
            
            // Update UI
            addMessageToUI(text, true, message.timestamp, true);
            messageInput.value = '';
            
            // Send to server for other user
            if (socket) {
                socket.emit('send-message', {
                    from: currentUser.username,
                    to: currentChat.friendUsername,
                    text: text
                });
            }
            
            // Update chats list
            loadChats();
        }

        function addMessageToUI(text, isSent, timestamp, animate = true) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Clear placeholder if exists
            if (messagesContainer.children.length === 1 && 
                messagesContainer.children[0].querySelector('.fa-comment')) {
                messagesContainer.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            if (animate) {
                messageDiv.style.animation = 'fadeIn 0.3s ease';
            }
            
            messageDiv.innerHTML = `
                ${text}
                <div class="message-time">${formatTime(timestamp)}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Profile Editing
        function openEditModal() {
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveProfile() {
            const newName = document.getElementById('editName').value.trim();
            const newUsername = document.getElementById('editUsername').value.trim();

            if (!newName || !newUsername) {
                alert('Заполните все поля');
                return;
            }

            // Update user data
            currentUser.name = newName;
            currentUser.username = newUsername;
            currentUser.avatar = newName.charAt(0).toUpperCase();
            
            // Update storage
            users[currentUser.username] = currentUser;
            localStorage.setItem('notmax_users', JSON.stringify(users));
            
            // Update UI
            updateUserProfile();
            closeEditModal();
        }

        // Left Menu Functions
        function openLeftMenu() {
            document.getElementById('leftMenu').classList.add('active');
        }

        function closeLeftMenu() {
            document.getElementById('leftMenu').classList.remove('active');
        }

        // WebRTC Functions
        async function createPeerConnection(isCaller) {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                document.getElementById('remoteVideo').srcObject = remoteStream;
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && socket) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        to: currentChat.friendUsername
                    });
                }
            };
        }

        async function startCall(isVideo) {
            if (!currentChat) {
                alert('Выберите чат для звонка');
                return;
            }

            try {
                currentCallType = isVideo ? 'video' : 'audio';
                isCaller = true;
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: isVideo
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('callInterface').style.display = 'block';
                document.getElementById('callStatus').textContent = 'Звонок...';
                document.getElementById('acceptBtn').style.display = 'none';
                document.getElementById('callerName').textContent = `Звонок ${currentChat.friendName}`;
                
                await createPeerConnection(true);
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                if (socket) {
                    socket.emit('call-user', {
                        sdp: offer,
                        to: currentChat.friendUsername,
                        type: currentCallType,
                        callerName: currentUser.name
                    });
                }
                
            } catch (error) {
                console.error('Error starting call:', error);
                alert('Ошибка доступа к камере/микрофону');
            }
        }

        async function acceptCall() {
            document.getElementById('callStatus').textContent = 'Разговор...';
            document.getElementById('acceptBtn').style.display = 'none';
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: currentCallType === 'video'
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
            } catch (error) {
                console.error('Error accepting call:', error);
            }
        }

        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            document.getElementById('callInterface').style.display = 'none';
            document.getElementById('acceptBtn').style.display = 'none';
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const btn = document.querySelector('.toggle-audio');
                    btn.style.background = audioTrack.enabled ? 'rgba(255,255,255,0.2)' : '#ff4757';
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const btn = document.querySelector('.toggle-video');
                    btn.style.background = videoTrack.enabled ? 'rgba(255,255,255,0.2)' : '#ff4757';
                    document.getElementById('localVideo').style.display = videoTrack.enabled ? 'block' : 'none';
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            
            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Send message on Enter
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Check if user is already logged in
            const savedUser = localStorage.getItem('notmax_current_user');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                loginUser(userData.username, userData.password);
            }
        });
    </script>
